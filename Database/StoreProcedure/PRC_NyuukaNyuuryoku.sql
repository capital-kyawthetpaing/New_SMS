
/****** Object:  StoredProcedure [dbo].[PRC_NyuukaNyuuryoku]    Script Date: 2020/10/01 19:36:58 ******/
DROP PROCEDURE [dbo].[PRC_NyuukaNyuuryoku]
GO
DROP TYPE [dbo].[T_NyuukaN]

/****** Object:  StoredProcedure [dbo].[PRC_NyuukaNyuuryoku]    Script Date: 2020/10/01 19:36:58 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE TYPE T_NyuukaN AS TABLE
    (
    [DataKbn][tinyint],		--1:Åyà¯ìñÅz,2:Åyî≠íçÅz,3:Åyà⁄ìÆÅz
    [ArrivalRows] [int],
    [ArrivalKBN] [tinyint] ,
    [OrderNO] [varchar](11) ,
    [OrderRows] [int],
--    [MoveNO] [varchar](11) ,
--    [MoveRows] [int],
    [ArrivalPlanNO] [varchar](11) ,
    [StockNO] [varchar](11) ,
    [ReserveNO] [varchar](11) ,
    [CustomerCD] [varchar](13) ,
    [ArrivalSu] [int] ,
    [OldArrivalSu] [int] ,
    [ArrivalPlanKBN][tinyint],
    [ChkFinish][tinyint],
    [UpdateFlg][tinyint]
    )
GO

CREATE PROCEDURE [dbo].[PRC_NyuukaNyuuryoku]
    (@OperateMode    int,                 -- èàóùãÊï™Åi1:êVãK 2:èCê≥ 3:çÌèúÅj
    @ArrivalNO   varchar(11),
    @VendorDeliveryNo  varchar(15),
    @StoreCD   varchar(4),
    @VendorCD   varchar(13),
    @ArrivalDate  varchar(10),
    @SoukoCD varchar(6) ,
    @StaffCD   varchar(10),
    @JANCD   varchar(13),
    @AdminNO int ,
    @SKUCD   varchar(30),
    @MakerItem   varchar(50),
    @ArrivalSu   int,

    @Table  T_NyuukaN READONLY,
    @Operator  varchar(10),
    @PC  varchar(30),
    @OutArrivalNO varchar(11) OUTPUT
)AS

--********************************************--
--                                            --
--                 èàóùäJén                   --
--                                            --
--********************************************--

BEGIN
    DECLARE @W_ERR  tinyint;
    DECLARE @SYSDATETIME datetime;
    DECLARE @OperateModeNm varchar(10);
    DECLARE @KeyItem varchar(100);
    DECLARE @ArrivalPlanNO varchar(11);
    DECLARE @StockNO  varchar(11);
    DECLARE @ReserveNO varchar(11);
    DECLARE @SYSDATE date;
    
    SET @W_ERR = 0;
    SET @SYSDATETIME = SYSDATETIME();
	SET @SYSDATE = CONVERT(date, @SYSDATETIME);
	
    --êVãK--
    IF @OperateMode = 1
    BEGIN
        SET @OperateModeNm = 'êVãK';
        
        --ì`ï[î‘çÜçÃî‘
        EXEC Fnc_GetNumber
            5,             --inì`ï[éÌï  5
            @ArrivalDate, --inäÓèÄì˙
            @StoreCD,       --inìXï‹CD
            @Operator,
            @ArrivalNO OUTPUT
            ;
        
        IF ISNULL(@ArrivalNO,'') = ''
        BEGIN
            SET @W_ERR = 1;
            RETURN @W_ERR;
        END
        
        --ÅyD_ArrivalÅzTableì]ëóédólÇ`
        INSERT INTO [D_Arrival]
           ([ArrivalNO]
           ,[VendorDeliveryNo]
           ,[StoreCD]
           ,[VendorCD]
           ,[ArrivalDate]
           ,[InputDate]
           ,[ArrivalKBN]
           ,[StaffCD]
           ,[SoukoCD]
           ,[RackNO]
           ,[JanCD]
           ,[AdminNO]
           ,[SKUCD]
           ,[MakerItem]
           ,[ArrivalSu]
           ,[PurchaseSu]
           ,[InsertOperator]
           ,[InsertDateTime]
           ,[UpdateOperator]
           ,[UpdateDateTime]
           ,[DeleteOperator]
           ,[DeleteDateTime])
     VALUES
           (@ArrivalNO     
           ,@VendorDeliveryNo        
           ,(SELECT top 1 M.StoreCD
             FROM M_Souko AS M
             WHERE M.SoukoCD = @SoukoCD
             AND M.ChangeDate <= @ArrivalDate
             ORDER BY M.ChangeDate desc)
           ,@VendorCD                                             
           ,convert(date,@ArrivalDate)  
           ,@SYSDATE    --InputDate
           ,(SELECT A.ArrivalPlanKBN
            FROM D_ArrivalPlan AS A
            WHERE A.ArrivalPlanNO = (SELECT top 1 tbl.ArrivalPlanNO FROM @Table tbl))	--ArrivalKBN
           ,@StaffCD
           ,@SoukoCD
           ,NULL    --RackNO
           ,@JANCD
           ,@AdminNO
           ,@SKUCD
           ,@MakerItem
           ,(CASE (SELECT top 1 tbl.ChkFinish FROM @Table tbl) WHEN 1 THEN 0
             ELSE @ArrivalSu END) --ArrivalSu
           ,0 --PurchaseSu
           ,@Operator  
           ,@SYSDATETIME
           ,@Operator  
           ,@SYSDATETIME
           ,NULL                  
           ,NULL
           );               

    END
    ELSE IF @OperateMode = 3 --çÌèú--
    BEGIN
        SET @OperateModeNm = 'çÌèú';
        
        DELETE FROM [D_Arrival]
         WHERE [ArrivalNO] = @ArrivalNO
         ;

        --ÅyD_ArrivalPlanÅz    ï™äÑï™çÌèúÅiDeleteÅjTableì]ëóédólÇbáA
        DELETE FROM [D_ArrivalPlan]
         WHERE EXISTS(SELECT 1
                        FROM @Table AS tbl
                       WHERE tbl.ArrivalPlanNO = [D_ArrivalPlan].OriginalArrivalPlanNO)
           AND InsertOperator = 'Nyuuka'
           ;

        --ÅyD_ArrivalPlanÅz     Update/Delete   Tableì]ëóédólÇbáA
        UPDATE [D_ArrivalPlan] SET
          -- [ArrivalPlanSu]  = D_ArrivalPlan.[ArrivalPlanSu] + ISNULL(DS2.ArrivalPlanSu,0)		--Åö
          --,
           [ArrivalSu]      = D_ArrivalPlan.[ArrivalSu] - tbl.ArrivalSu
          ,[UpdateOperator] = @Operator  
          ,[UpdateDateTime] = @SYSDATETIME
        
        FROM (SELECT tbl.ArrivalPlanNO, SUM(tbl.ArrivalSu) AS ArrivalSu
              FROM @Table AS tbl
              WHERE tbl.UpdateFlg >= 0
              GROUP BY tbl.ArrivalPlanNO
        ) AS tbl
        /*
        LEFT OUTER JOIN (SELECT D.OriginalArrivalPlanNO
                              , SUM(D.ArrivalPlanSu) AS ArrivalPlanSu
                         FROM D_ArrivalPlan D
                         GROUP BY D.OriginalArrivalPlanNO
        )AS DS2
        ON DS2.OriginalArrivalPlanNO = tbl.ArrivalPlanNO
        */
        WHERE tbl.ArrivalPlanNO = D_ArrivalPlan.ArrivalPlanNO
        ;
    END
    
    --ÅyD_ArrivalDetailsÅzTableì]ëóédólÇa
    --çsçÌèúÇ≥ÇÍÇΩÉfÅ[É^ÇÕDELETEèàóù
    DELETE FROM [D_ArrivalDetails]
     WHERE [ArrivalNO] = @ArrivalNO
     ;
         
    IF @OperateMode <= 2    --êVãKÅEèCê≥éû
    BEGIN
        --ÉeÅ[ÉuÉãì]ëóédólÇa
        INSERT INTO [D_ArrivalDetails]
                   ([ArrivalNO]
                   ,[ArrivalRows]
                   ,[ArrivalKBN]
                   ,[Number]
                   ,[ArrivalPlanNO]
                   ,[ArrivalSu]
                   ,[PurchaseSu]

                   ,[InsertOperator]
                   ,[InsertDateTime]
                   ,[UpdateOperator]
                   ,[UpdateDateTime])
             SELECT @ArrivalNO                         
                   ,tbl.ArrivalRows                       
                   ,tbl.ArrivalKBN
                   ,tbl.OrderNO	--Åyà¯ìñÅzÇ»ÇÁéÛíçî‘çÜÅAÅyç›å…ÅzÇ»ÇÁî≠íçÅEà⁄ìÆî‘çÜ
                   ,tbl.ArrivalPlanNO  --ArrivalPlanNO
                   ,(CASE tbl.ChkFinish WHEN 1 THEN 0
                     ELSE tbl.ArrivalSu END)
                   ,0

                   ,@Operator  
                   ,@SYSDATETIME
                   ,@Operator  
                   ,@SYSDATETIME

              FROM @Table tbl
              WHERE tbl.UpdateFlg <> 2
              ;
        
        --ÉJÅ[É\ÉãíËã`
        DECLARE CUR_TABLE CURSOR FOR
            SELECT tbl.ArrivalPlanNO, tbl.StockNO, tbl.ReserveNO, tbl.ArrivalSu
                  ,DS.PlanSu-tbl.ArrivalSu AS ArrivalPlanSu	--Åiå≥ÇÃÉåÉRÅ[ÉhÇÃPlanSu - âÊñ ñæç◊.ì¸â◊êîÅj>ÇOÇ»ÇÁINSERT
                  ,DS.PlanSu-SUM(tbl.ArrivalSu) OVER(PARTITION BY tbl.ArrivalPlanNO, tbl.StockNO) AS SUM_ArrivalPlanSu
                  ,SUM(tbl.ArrivalSu) OVER(PARTITION BY tbl.ArrivalPlanNO, tbl.StockNO) AS SUM_ArrivalSu
                  ,tbl.DataKbn
                  ,(CASE WHEN DP.InsertOperator = 'Nyuuka' THEN 0 ELSE 1 END) AS SakuseiFlg
                  ,(SELECT DR.ReserveSu - tbl.ArrivalSu    --å≥ÇÃÉåÉRÅ[ÉhÇÃReserveSu - ñæç◊ì¸â◊êî(ãÊï™Ç™à¯ìñÇÃâÊñ Ç…ï\é¶Ç≥ÇÍÇÈà¯ìñêîÇ∆ì¸â◊êî)  
                      FROM D_Reserve AS DR 
                     WHERE DR.ReserveNO = tbl.ReserveNO) AS ReserveSu
            FROM @Table AS tbl
            LEFT OUTER JOIN D_ArrivalPlan AS DP
            ON DP.ArrivalPlanNO = tbl.ArrivalPlanNO
            AND DP.DeleteDateTime IS NULL
            LEFT OUTER JOIN D_Stock As DS
            ON DS.StockNO = tbl.StockNO
            AND DS.DeleteDateTime IS NULL
            WHERE tbl.UpdateFlg <> 2
            AND tbl.ChkFinish = 0
            ORDER BY tbl.ArrivalPlanNO
            ;
        
        DECLARE @tblArrivalPlanNO varchar(11);
        DECLARE @oldArrivalPlanNO varchar(11);
        DECLARE @tblStockNO       varchar(11);
        DECLARE @tblReserveNO     varchar(11);
        DECLARE @tblArrivalSu     int;
        DECLARE @tblArrivalPlanSu int;
        DECLARE @sumArrivalPlanSu int;
        DECLARE @sumArrivalSu     int;
        DECLARE @tblReserveSu     int;
        DECLARE @tblDataKbn       tinyint;    --1:Åyà¯ìñÅz,2:Åyî≠íçÅz,3:Åyà⁄ìÆÅz
        DECLARE @SakuseiFlg       tinyint;    --0:çÏê¨ÇµÇ»Ç¢Å@1:çÏê¨Ç∑ÇÈ

        --ÉJÅ[É\ÉãÉIÅ[ÉvÉì
        OPEN CUR_TABLE;

        --ç≈èâÇÃ1çsñ⁄ÇéÊìæÇµÇƒïœêîÇ÷ílÇÉZÉbÉg
        FETCH NEXT FROM CUR_TABLE
        INTO @tblArrivalPlanNO, @tblStockNO, @tblReserveNO, @tblArrivalSu, @tblArrivalPlanSu, @sumArrivalPlanSu, @sumArrivalSu, @tblDataKbn, @SakuseiFlg, @tblReserveSu;
        
        SET @oldArrivalPlanNO = '';
        
        --ÉfÅ[É^ÇÃçsêîï™ÉãÅ[ÉvèàóùÇé¿çsÇ∑ÇÈ
        WHILE @@FETCH_STATUS = 0
        BEGIN
        -- ========= ÉãÅ[Évì‡ÇÃé¿ç€ÇÃèàóù Ç±Ç±Ç©ÇÁ===
            
            IF (@sumArrivalPlanSu > 0 OR @tblReserveSu > 0) AND @SakuseiFlg = 1
            BEGIN
                IF @oldArrivalPlanNO <> @tblArrivalPlanNO 
                BEGIN
                    --ì`ï[î‘çÜçÃî‘
                    EXEC Fnc_GetNumber
                        22,             --inì`ï[éÌï  5
                        @ArrivalDate, --inäÓèÄì˙
                        @StoreCD,       --inìXï‹CD
                        @Operator,
                        @ArrivalPlanNO OUTPUT
                        ;
                    
                    IF ISNULL(@ArrivalPlanNO,'') = ''
                    BEGIN
                        SET @W_ERR = 1;
                        RETURN @W_ERR;
                    END
                
                    --ÅyD_ArrivalPlanÅzï™äÑï™çXêVÅiInsertÅj Tableì]ëóédólÇb     TableÇÃÉfÅ[É^ÇLoopÇ∑ÇÈïKóvÇ†ÇË?
                    INSERT INTO [D_ArrivalPlan]
                           ([ArrivalPlanNO]
                           ,[ArrivalPlanKBN]
                           ,[Number]
                           ,[NumberRows]
                           ,[NumberSEQ]
                           ,[ArrivalPlanDate]
                           ,[ArrivalPlanMonth]
                           ,[ArrivalPlanCD]
                           ,[CalcuArrivalPlanDate]
                           ,[ArrivalPlanUpdateDateTime]
                           ,[StaffCD]
                           ,[LastestFLG]
                           ,[EDIImportNO]
                           ,[SoukoCD]
                           ,[SKUCD]
                           ,[AdminNO]
                           ,[JanCD]
                           ,[ArrivalPlanSu]
                           ,[ArrivalSu]
                           ,[OriginalArrivalPlanNO]
                           ,[OrderCD]
                           ,[FromSoukoCD]
                           ,[ToStoreCD]
                           ,[InsertOperator]
                           ,[InsertDateTime]
                           ,[UpdateOperator]
                           ,[UpdateDateTime]
                           ,[DeleteOperator]
                           ,[DeleteDateTime])
                     SELECT
                            @ArrivalPlanNO
                           ,DP.ArrivalPlanKBN
                           ,DP.Number
                           ,DP.NumberRows
                           ,DP.NumberSEQ
                           ,DP.ArrivalPlanDate
                           ,DP.ArrivalPlanMonth
                           ,DP.ArrivalPlanCD
                           ,DP.CalcuArrivalPlanDate
                           ,@SYSDATETIME    --ArrivalPlanUpdateDateTime
                           ,@StaffCD
                           ,1 AS LastestFLG
                           ,DP.EDIImportNO
                           ,DP.SoukoCD
                           ,DP.SKUCD
                           ,DP.AdminNO
                           ,DP.JanCD
                           ,(CASE WHEN DP.ArrivalPlanSu-@tblArrivalSu > 0 THEN DP.ArrivalPlanSu-@tblArrivalSu
                                  ELSE @tblReserveSu END) --å≥ÇÃÉåÉRÅ[ÉhÇÃArrivalPlanSu - ñæç◊ì¸â◊êî
                           ,0   --ArrivalSu
                           ,DP.ArrivalPlanNO    --å≥ÇÃÉåÉRÅ[ÉhÇÃArrivalPlanNO
                           ,DP.OrderCD
                           ,DP.FromSoukoCD
                           ,DP.ToStoreCD
                           ,@Operator  
                           ,@SYSDATETIME
                           ,@Operator  
                           ,@SYSDATETIME
                           ,NULL                  
                           ,NULL
                     FROM D_ArrivalPlan AS DP
                     WHERE DP.ArrivalPlanNO = @tblArrivalPlanNO
                     AND DP.DeleteDateTime IS NULL
                     --AND DP.ArrivalPlanSu-@tblArrivalSu > 0
                     ;
                    
                    --ì`ï[î‘çÜçÃî‘
                    EXEC Fnc_GetNumber
                        21,             --inì`ï[éÌï  21
                        @ArrivalDate, --inäÓèÄì˙
                        @StoreCD,       --inìXï‹CD
                        @Operator,
                        @StockNO OUTPUT
                        ;
                    
                    IF ISNULL(@StockNO,'') = ''
                    BEGIN
                        SET @W_ERR = 1;
                        RETURN @W_ERR;
                    END
                    
                    --ÅyD_StockÅzï™äÑï™çXêVÅiInsertÅj
                    INSERT INTO [D_Stock]
                           ([StockNO]
                           ,[SoukoCD]
                           ,[RackNO]
                           ,[ArrivalPlanNO]
                           ,[SKUCD]
                           ,[AdminNO]
                           ,[JanCD]
                           ,[ArrivalYetFLG]
                           ,[ArrivalPlanKBN]
                           ,[ArrivalPlanDate]
                           ,[ArrivalDate]
                           ,[StockSu]
                           ,[PlanSu]
                           ,[AllowableSu]
                           ,[AnotherStoreAllowableSu]
                           ,[ReserveSu]
                           ,[InstructionSu]
                           ,[ShippingSu]
                           ,[OriginalStockNO]
                           ,[ExpectReturnDate]
                           ,[ReturnDate]
                           ,[ReturnSu]
                           ,[InsertOperator]
                           ,[InsertDateTime]
                           ,[UpdateOperator]
                           ,[UpdateDateTime]
                           ,[DeleteOperator]
                           ,[DeleteDateTime])
                     SELECT
                            @StockNO
                           ,DS.SoukoCD
                           ,NULL    --RackNO
                           ,@ArrivalPlanNO
                           ,DS.SKUCD
                           ,DS.AdminNO
                           ,DS.JanCD
                           ,1   --  ArrivalYetFLG
                           ,DS.ArrivalPlanKBN
                           ,DS.ArrivalPlanDate
                           ,NULL    --ArrivalDate
                           ,0   --StockSu
                           ,@sumArrivalPlanSu   --PlanSu
                           --å≥ÇÃÉåÉRÅ[ÉhÇÃAllowableSu-ç∂ãL å≥ÇÃÉåÉRÅ[ÉhÇ÷çXêVÇµÇΩíl
                           ,DS.AllowableSu-(CASE WHEN @sumArrivalSu - DS.ReserveSu > 0 THEN @sumArrivalSu - DS.ReserveSu ELSE 0 END)--AllowableSu
                           --å≥ÇÃÉåÉRÅ[ÉhÇÃAnotherStoreAllowableSu-ç∂ãL å≥ÇÃÉåÉRÅ[ÉhÇ÷çXêVÇµÇΩíl
                           ,DS.AnotherStoreAllowableSu - (CASE WHEN @sumArrivalSu - DS.ReserveSu > 0 THEN @sumArrivalSu - DS.ReserveSu ELSE 0 END)  --AnotherStoreAllowableSu
                           --å≥ÇÃÉåÉRÅ[ÉhÇÃReserveSu-ç∂ãL å≥ÇÃÉåÉRÅ[ÉhÇ÷çXêVÇµÇΩíl
                           ,DS.ReserveSu - (CASE WHEN @sumArrivalSu - DS.ReserveSu > 0 THEN DS.ReserveSu ELSE @sumArrivalSu END)  --ReserveSu
                           ,DS.InstructionSu
                           ,DS.ShippingSu
                           ,DS.StockNO  --OriginalStockNO
                           ,DS.ExpectReturnDate
                           ,DS.ReturnDate
                           ,DS.ReturnSu
                     
                           ,@Operator  
                           ,@SYSDATETIME
                           ,@Operator  
                           ,@SYSDATETIME
                           ,NULL                  
                           ,NULL
                     FROM D_Stock AS DS
                     WHERE DS.StockNO = @tblStockNO
                    ;
                                        
                END     --@tblArrivalPlanNOÇ™àŸÇ»ÇÈèÍçá
                
                ELSE
                BEGIN
                    --ñæç◊ì‡Ç≈ìØÇ∂ArrivalPlanNOÅAStockNOÇÃèÍçáÇÕêVãKÇ…INSERTÇπÇ∏êîó ÇUPDATEÅiINSERTÇ∑ÇÈÇ∆ç›å…Ç™î{ëùÇµÇƒÇµÇ‹Ç§Åj
                    UPDATE D_ArrivalPlan SET
                       [ArrivalPlanSu] = ArrivalPlanSu - @tblArrivalSu
                     WHERE ArrivalPlanNO = @ArrivalPlanNO
                     AND ArrivalPlanSu-@tblArrivalSu >= 0
                     ;
                    
                   -- --ÅyD_StockÅz           Update  Tableì]ëóédólÇc
                   -- UPDATE [D_Stock] SET
                   --    -- StockSu = StockSu + @tblArrivalSu
                   --    --,PlanSu = PlanSu + @tblArrivalPlanSu	--(CASE WHEN PlanSu - @tblArrivalSu > 0 THEN PlanSu - @tblArrivalSu ELSE 0 END)   --PlanSu
                   --     PlanSu = (CASE WHEN PlanSu - @tblArrivalSu <= 0 THEN 0 ELSE PlanSu - @tblArrivalSu END)
                   --    --,AllowableSu = AllowableSu - @tblArrivalSu   --AllowableSu
                   --    --,AnotherStoreAllowableSu = AnotherStoreAllowableSu - @tblArrivalSu   --AnotherStoreAllowableSu
                   --    --,ReserveSu = ReserveSu - @tblArrivalSu   --ReserveSu
                   --    ,ReserveSu = (CASE WHEN ReserveSu - @tblArrivalSu <= 0 THEN 0 ELSE ReserveSu - @tblArrivalSu END)  --ReserveSu
                   -- WHERE StockNO = @StockNO
                   -- ;
                END
                
                
                IF @tblDataKbn = 1 AND @tblReserveSu > 0
                BEGIN
                    --ì`ï[î‘çÜçÃî‘
                    EXEC Fnc_GetNumber
                        12,             --inì`ï[éÌï  12
                        @ArrivalDate, --inäÓèÄì˙
                        @StoreCD,       --inìXï‹CD
                        @Operator,
                        @ReserveNO OUTPUT
                        ;
                    
                    IF ISNULL(@ReserveNO,'') = ''
                    BEGIN
                        SET @W_ERR = 1;
                        RETURN @W_ERR;
                    END
                    
                    --ÅyD_ReserveÅzï™äÑï™çXêVÅiInsertÅj
                    INSERT INTO [D_Reserve]
                           ([ReserveNO]
                           ,[ReserveKBN]
                           ,[Number]
                           ,[NumberRows]
                           ,[StockNO]
                           ,[SoukoCD]
                           ,[JanCD]
                           ,[SKUCD]
                           ,[AdminNO]
                           ,[ReserveSu]
                           ,[ShippingPossibleDate]
                           ,[ShippingPossibleSU]
                           ,[ShippingOrderNO]
                           ,[ShippingOrderRows]
                           ,[CompletedPickingNO]
                           ,[CompletedPickingRow]
                           ,[CompletedPickingDate]
                           ,[ShippingSu]
                           ,[ReturnKBN]
                           ,[OriginalReserveNO]
                           ,[InsertOperator]
                           ,[InsertDateTime]
                           ,[UpdateOperator]
                           ,[UpdateDateTime]
                           ,[DeleteOperator]
                           ,[DeleteDateTime])
                     SELECT
                           @ReserveNO
                           ,DR.ReserveKBN
                           ,DR.Number
                           ,DR.NumberRows
                           ,@StockNO
                           ,DR.SoukoCD
                           ,DR.JanCD
                           ,DR.SKUCD
                           ,DR.AdminNO
                           ,DR.ReserveSu - @tblArrivalSu    --ReserveSu = å≥ÇÃÉåÉRÅ[ÉhÇÃReserveSu - ñæç◊ì¸â◊êî
                           ,NULL    --ShippingPossibleDate
                           ,0       --ShippingPossibleSU
                           ,NULL    --ShippingOrderNO
                           ,0       --ShippingOrderRows
                           ,NULL    --CompletedPickingNO
                           ,0       --CompletedPickingRow
                           ,NULL    --CompletedPickingDate
                           ,0       --ShippingSu
                           ,0       --ReturnKBN
                           ,DR.ReserveNO AS OriginalReserveNO
                     
                           ,@Operator  
                           ,@SYSDATETIME
                           ,@Operator  
                           ,@SYSDATETIME
                           ,NULL                  
                           ,NULL
                     FROM D_Reserve AS DR
                     WHERE @tblReserveNO = DR.ReserveNO
                    ;
                END
            END
            
            --ÅyD_StockÅz           Update  Tableì]ëóédólÇc
            UPDATE [D_Stock] SET
                   [ArrivalYetFLG]           = 0
                  ,[ArrivalDate]             = @SYSDATE
                  ,[StockSu]                 = [StockSu] + @tblArrivalSu
                  ,[PlanSu]                  = 0
                  ,[AllowableSu]             = (CASE WHEN @tblArrivalSu - ReserveSu > 0 THEN @tblArrivalSu - ReserveSu ELSE 0 END)   --AllowableSu
                  ,[AnotherStoreAllowableSu] = (CASE WHEN @tblArrivalSu - ReserveSu > 0 THEN @tblArrivalSu - ReserveSu ELSE 0 END)   --AnotherStoreAllowableSu
                  ,[ReserveSu]               = (CASE WHEN @tblArrivalSu - ReserveSu > 0 THEN ReserveSu ELSE @tblArrivalSu END)   --ReserveSu
                  ,[UpdateOperator]          = @Operator  
                  ,[UpdateDateTime]          = @SYSDATETIME
                  
             FROM D_Stock AS DS
             WHERE DS.StockNO = @tblStockNO
             AND DS.DeleteDateTime IS NULL
            ;
            
            IF @tblDataKbn = 1
            BEGIN
                --ÅyD_ReserveÅz         Update  Tableì]ëóédólÇd
                UPDATE [D_Reserve] SET
                       [ReserveSu]            = [ShippingPossibleSU] + @tblArrivalSu   --ñ¢ämîF
                      ,[ShippingPossibleDate] = @SYSDATE
                      ,[ShippingPossibleSU]   = [ShippingPossibleSU] + @tblArrivalSu
                      ,[UpdateOperator]       = @Operator  
                      ,[UpdateDateTime]       = @SYSDATETIME
                      
                 FROM D_Reserve AS DR
                 WHERE DR.ReserveNO  = @tblReserveNO
                 AND DR.DeleteDateTime IS NULL
                ;
            END
            
            SET @oldArrivalPlanNO = @tblArrivalPlanNO;
            
            --éüÇÃçsÇÃÉfÅ[É^ÇéÊìæÇµÇƒïœêîÇ÷ílÇÉZÉbÉg
            FETCH NEXT FROM CUR_TABLE
            INTO @tblArrivalPlanNO, @tblStockNO, @tblReserveNO, @tblArrivalSu, @tblArrivalPlanSu, @sumArrivalPlanSu, @sumArrivalSu, @tblDataKbn, @SakuseiFlg, @tblReserveSu;

        END
        
        --ÉJÅ[É\ÉãÇï¬Ç∂ÇÈ
        CLOSE CUR_TABLE;
        DEALLOCATE CUR_TABLE;

        --ÅyD_ArrivalPlanÅzUpdate   Tableì]ëóédólÇb,Çbá@
        UPDATE [D_ArrivalPlan] SET
           [ArrivalPlanSu]  = tbl.ArrivalSu
          ,[ArrivalSu]      = tbl.ArrivalSu
          ,[UpdateOperator] = @Operator  
          ,[UpdateDateTime] = @SYSDATETIME
        
         FROM (SELECT tbl.ArrivalPlanNO
                    , SUM((CASE tbl.ChkFinish WHEN 1 THEN 0
                                              ELSE tbl.ArrivalSu END)) AS ArrivalSu
                 FROM @Table AS tbl
                WHERE tbl.UpdateFlg <> 2
                GROUP BY tbl.ArrivalPlanNO
         ) AS tbl
         WHERE tbl.ArrivalPlanNO = D_ArrivalPlan.ArrivalPlanNO
        ;
        
        --äÆî[éûÇÃÇ›
        --ÅyD_StockÅz           UpdateÅ@Tableì]ëóédólÇcá@
        UPDATE [D_Stock] SET
               [ArrivalYetFLG]           = 0
              ,[ArrivalDate]             = @SYSDATE
              ,[StockSu]                 = 0
              ,[PlanSu]                  = 0
              ,[AllowableSu]             = 0
              ,[AnotherStoreAllowableSu] = 0
              ,[ReserveSu]               = 0
              ,[InstructionSu]           = 0
              ,[ShippingSu]              = 0
              ,[OriginalStockNO]         = 0
              ,[ExpectReturnDate]        = NULL
              ,[ReturnPlanSu]            = 0
              ,[VendorCD]                = 0
              ,[ReturnDate]              = NULL
              ,[ReturnSu]                = 0
              ,[UpdateOperator]          = @Operator  
              ,[UpdateDateTime]          = @SYSDATETIME
              
         FROM @Table AS tbl
         WHERE D_Stock.StockNO = tbl.StockNO
         AND tbl.ChkFinish = 1
        ;

        
    END
    ELSE    --çÌèúéû
    BEGIN
        /*
        --ÅyD_ArrivalPlanÅz  ï™äÑï™çÌèúÅiDeleteÅj
        DELETE FROM D_ArrivalPlan
        WHERE EXISTS (SELECT 1 FROM D_ArrivalPlan AS DP 
                       INNER JOIN @Table AS tbl
                          ON tbl.ArrivalPlanNO = DP.ArrivalPlanNO
                         AND tbl.UpdateFlg >= 0
                       WHERE DP.ArrivalPlanNO = D_ArrivalPlan.OriginalArrivalPlanNO)
        ;
        */

        --ÅyD_StockÅz           Update/Delete   Tableì]ëóédólÇcáA
        UPDATE [D_Stock] SET
               [ArrivalYetFLG]           = 1
              ,[ArrivalDate]             = NULL
              ,[StockSu]                 = [D_Stock].[StockSu] - tbl.ArrivalSu
              ,[PlanSu]                  = [D_Stock].[PlanSu] + tbl.ArrivalSu --+ ISNULL(DS2.PlanSu,0)
              --,[AllowableSu]             = [D_Stock].[AllowableSu] + ISNULL(DS2.PlanSu,0)
              --,[AnotherStoreAllowableSu] = [D_Stock].[AnotherStoreAllowableSu] + ISNULL(DS2.AnotherStoreAllowableSu,0)
              --,[ReserveSu]               = [D_Stock].[ReserveSu] + ISNULL(DS2.ReserveSu,0)
              ,[UpdateOperator]          = @Operator  
              ,[UpdateDateTime]          = @SYSDATETIME
              
         FROM (SELECT tbl.StockNO, SUM(tbl.ArrivalSu) AS ArrivalSu
                 FROM @Table AS tbl
                WHERE tbl.UpdateFlg >= 0
                GROUP BY tbl.StockNO
         ) AS tbl
         /*
         LEFT OUTER JOIN (SELECT D.OriginalStockNO
                               , SUM(D.PlanSu) AS PlanSu
                               , SUM(D.AnotherStoreAllowableSu) AS AnotherStoreAllowableSu
                               , SUM(D.ReserveSu) AS ReserveSu
                            FROM D_Stock D
                           GROUP BY D.OriginalStockNO
         )AS DS2
         ON DS2.OriginalStockNO = tbl.StockNO
         */
         WHERE D_Stock.StockNO = tbl.StockNO
           AND D_Stock.ArrivalYetFLG = 0   --ìØÇ∂StockNOÇ…ëŒÇµÇƒï°êîâÒUpdateÇµÇ»Ç¢ÇÊÇ§Ç…
        ;
        
        --ÅyD_StockÅz  ï™äÑï™çÌèúÅiDeleteÅj
        /*
        DELETE FROM D_Stock
        WHERE EXISTS (SELECT 1 FROM D_Stock AS DS
                       INNER JOIN @Table AS tbl
                          ON tbl.StockNO = DS.StockNO
                         AND tbl.UpdateFlg = 0
                       WHERE DS.StockNO = D_Stock.OriginalStockNO)
        ;
        */
        
        --ÅyD_ReserveÅz         Update/Delete   Tableì]ëóédólÇdáA
        UPDATE [D_Reserve] SET
               [ShippingPossibleDate] = NULL
              ,[ShippingPossibleSU]   = [ShippingPossibleSU] - tbl.ArrivalSu
              ,[UpdateOperator]       = @Operator  
              ,[UpdateDateTime]       = @SYSDATETIME
              
        FROM @Table AS tbl
        WHERE tbl.ReserveNO = D_Reserve.ReserveNO
        AND tbl.UpdateFlg = 0
        AND tbl.DataKbn = 1
        ;
        
        /*
        --ÅyD_ReserveÅz  ï™äÑï™çÌèúÅiDeleteÅj
        DELETE FROM D_Reserve
        WHERE EXISTS (SELECT 1 FROM D_Reserve AS DR
                       INNER JOIN @Table AS tbl
                          ON tbl.ReserveNO = DR.ReserveNO
                         AND tbl.UpdateFlg = 0
                         AND tbl.DataKbn = 1
                       WHERE DR.OriginalReserveNO = D_Reserve.ReserveNO)
        ;
        */

    END

    --ÅyD_WarehousingÅzí«â¡çXêVÅiInsert)  Tableì]ëóédólÇe î≠íç
    INSERT INTO [D_Warehousing]
       ([WarehousingDate]
       ,[SoukoCD]
       ,[RackNO]
       ,[StockNO]
       ,[JanCD]
       ,[AdminNO]
       ,[SKUCD]
       ,[WarehousingKBN]
       ,[DeleteFlg]
       ,[Number]
       ,[NumberRow]
       ,[VendorCD]
       ,[ToStoreCD]
       ,[ToSoukoCD]
       ,[ToRackNO]
       ,[ToStockNO]
       ,[FromStoreCD]
       ,[FromSoukoCD]
       ,[FromRackNO]
       ,[CustomerCD]
       ,[Quantity]
       ,[Program]
       ,[InsertOperator]
       ,[InsertDateTime]
       ,[UpdateOperator]
       ,[UpdateDateTime]
       ,[DeleteOperator]
       ,[DeleteDateTime])
    SELECT (CASE WHEN @OperateMode = 3 THEN (CASE WHEN @ArrivalDate > @SYSDATE THEN @ArrivalDate ELSE @SYSDATE END)
                 ELSE @ArrivalDate END)	--WarehousingDate
       ,@SoukoCD
       ,NULL            --RackNO
       ,@StockNO
       ,@JanCD
       ,@AdminNO
       ,@SKUCD
       ,1               --WarehousingKBN
       ,(CASE WHEN @OperateMode = 3 THEN 1 ELSE 0 END)  --DeleteFlg
       ,@ArrivalNO      --Number
       ,tbl.ArrivalRows --NumberRow
       ,@VendorCD
       ,NULL    --ToStoreCD
       ,NULL    --ToSoukoCD
       ,NULL    --ToRackNO
       ,NULL    --ToStockNO
       ,NULL    --FromStoreCD
       ,NULL    --FromSoukoCD
       ,NULL    --FromRackNO
       ,tbl.CustomerCD
       ,(CASE @OperateMode WHEN 3 THEN -1 ELSE 1 END) * tbl.ArrivalSu	--Quantity
       ,'NyuukaNyuuryoku'	--Program
       
       ,@Operator  
       ,@SYSDATETIME
       ,@Operator  
       ,@SYSDATETIME
       ,NULL
       ,NULL

      FROM @Table tbl
      WHERE tbl.UpdateFlg <> 2
      AND tbl.ArrivalPlanKBN = 1	--î≠íç
      AND tbl.ChkFinish = 0
      ;

    --ÅyD_WarehousingÅzí«â¡çXêVÅiInsert)  Tableì]ëóédólÇe à⁄ìÆ
	INSERT INTO [D_Warehousing]
       ([WarehousingDate]
       ,[SoukoCD]
       ,[RackNO]
       ,[StockNO]
       ,[JanCD]
       ,[AdminNO]
       ,[SKUCD]
       ,[WarehousingKBN]
       ,[DeleteFlg]
       ,[Number]
       ,[NumberRow]
       ,[VendorCD]
       ,[ToStoreCD]
       ,[ToSoukoCD]
       ,[ToRackNO]
       ,[ToStockNO]
       ,[FromStoreCD]
       ,[FromSoukoCD]
       ,[FromRackNO]
       ,[CustomerCD]
       ,[Quantity]
       ,[Program]
       ,[InsertOperator]
       ,[InsertDateTime]
       ,[UpdateOperator]
       ,[UpdateDateTime]
       ,[DeleteOperator]
       ,[DeleteDateTime])
    SELECT @ArrivalDate	--WarehousingDate
       ,@SoukoCD
       ,NULL	--RackNO
       ,@StockNO
       ,@JanCD
       ,@AdminNO
       ,@SKUCD
 --      ,14    --WarehousingKBN
        ,41     --2020/10/01 Fukuda 
       ,(CASE WHEN @OperateMode = 3 THEN 1 ELSE 0 END)	--DeleteFlg
       ,@ArrivalNO	--Number
       ,tbl.ArrivalRows --NumberRow
       ,NULL    --VendorCD
       ,NULL    --ToStoreCD
       ,NULL    --ToSoukoCD
       ,NULL    --ToRackNO
       ,NULL    --ToStockNO
       ,(SELECT top 1 M.StoreCD
           FROM M_Souko AS M
          WHERE M.SoukoCD = @SoukoCD
            AND M.ChangeDate <= @ArrivalDate
          ORDER BY M.ChangeDate desc)  --FromStoreCD
       ,@SoukoCD	--FromSoukoCD]
       ,NULL	--FromRackNO
       ,tbl.CustomerCD
       ,(CASE @OperateMode WHEN 3 THEN -1 ELSE 1 END) * tbl.ArrivalSu	--Quantity
       ,'NyuukaNyuuryoku'	--Program
       
       ,@Operator  
       ,@SYSDATETIME
       ,@Operator  
       ,@SYSDATETIME
       ,NULL
       ,NULL

      FROM @Table tbl
      WHERE tbl.UpdateFlg <> 2
      AND tbl.ArrivalPlanKBN = 2	--à⁄ìÆ
      AND tbl.ChkFinish = 0
      ;
    
    --ÉJÅ[É\ÉãíËã`
    DECLARE CUR_AAA CURSOR FOR
            SELECT tbl.OrderNO, tbl.OrderRows, tbl.ArrivalSu
              FROM @Table AS tbl
             WHERE tbl.DataKbn > 1
               AND tbl.ChkFinish = 0
        UNION ALL
            SELECT DO.OrderNO, DO.OrderRows, tbl.ArrivalSu
              FROM @Table AS tbl
             INNER JOIN D_OrderDetails AS DO
                ON DO.JuchuuNO = tbl.OrderNO
               AND DO.JuchuuRows = tbl.OrderRows
             WHERE tbl.DataKbn = 1
               AND tbl.ChkFinish = 0
        ORDER BY OrderNO, OrderRows
        ;
    
    DECLARE @OrderNO varchar(11);
    DECLARE @OrderRows int;
    
    --ÉJÅ[É\ÉãÉIÅ[ÉvÉì
    OPEN CUR_AAA;

    --ç≈èâÇÃ1çsñ⁄ÇéÊìæÇµÇƒïœêîÇ÷ílÇÉZÉbÉg
    FETCH NEXT FROM CUR_AAA
    INTO @OrderNO, @OrderRows, @tblArrivalSu;
    
    --ÉfÅ[É^ÇÃçsêîï™ÉãÅ[ÉvèàóùÇé¿çsÇ∑ÇÈ
    WHILE @@FETCH_STATUS = 0
    BEGIN
    -- ========= ÉãÅ[Évì‡ÇÃé¿ç€ÇÃèàóù Ç±Ç±Ç©ÇÁ===
        --óöóÉtÉ@ÉCÉãÇÃSEQÇ™èdï°ÇµÇƒÇµÇ‹Ç§ÇΩÇﬂÉwÉbÉ_Ç‡çXêV
        UPDATE D_Order SET
            [UpdateOperator]  =  @Operator  
           ,[UpdateDateTime]  =  @SYSDATETIME
         WHERE OrderNO = @OrderNO
         ;
         
        --ÅyD_OrderDetailsÅz    Update  Tableì]ëóédólÇf     TableÇÃÉfÅ[É^ÇLoopÇ∑ÇÈïKóvÇ†ÇË
        UPDATE D_OrderDetails
            SET [TotalArrivalSu] = [TotalArrivalSu] + (CASE WHEN @OperateMode = 3 THEN -1 * @tblArrivalSu 
                                                            ELSE @tblArrivalSu END)
               ,[UpdateOperator] = @Operator  
               ,[UpdateDateTime] = @SYSDATETIME
         WHERE OrderNO = @OrderNO
         AND OrderRows = @OrderRows
         ;
            
        --ÅyD_MoveDetailsÅz     Update  Tableì]ëóédólÇg
        UPDATE D_MoveDetails
            SET [TotalArrivalSu] = [TotalArrivalSu] + (CASE WHEN @OperateMode = 3 THEN -1 * @tblArrivalSu 
                                                            ELSE @tblArrivalSu END)
               ,[UpdateOperator] = @Operator  
               ,[UpdateDateTime] = @SYSDATETIME
         WHERE MoveNO = @OrderNO
         AND MoveRows = @OrderRows
         ;
        -- ========= ÉãÅ[Évì‡ÇÃé¿ç€ÇÃèàóù Ç±Ç±Ç‹Ç≈===

        --éüÇÃçsÇÃÉfÅ[É^ÇéÊìæÇµÇƒïœêîÇ÷ílÇÉZÉbÉg
        FETCH NEXT FROM CUR_AAA
        INTO @OrderNO, @OrderRows, @tblArrivalSu;

    END
    
    --ÉJÅ[É\ÉãÇï¬Ç∂ÇÈ
    CLOSE CUR_AAA;
    DEALLOCATE CUR_AAA;
    
    --èàóùóöóÉfÅ[É^Ç÷çXêV
    SET @KeyItem = @ArrivalNO;
        
    EXEC L_Log_Insert_SP
        @SYSDATETIME,
        @Operator,
        'NyuukaNyuuryoku',
        @PC,
        @OperateModeNm,
        @KeyItem;

    SET @OutArrivalNO = @ArrivalNO;
    
--<<OWARI>>
  return @W_ERR;

END


GO


